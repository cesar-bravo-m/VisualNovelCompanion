<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="VNC.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:VNC"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="VNC">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="5" />
            <ColumnDefinition Width="1*" />
        </Grid.ColumnDefinitions>
        
        <!-- Control Panel -->
        <StackPanel Grid.Row="0" Grid.ColumnSpan="3" Margin="20" Spacing="10">
            <TextBlock Text="VNC Window Video Stream with LLM Analysis" 
                       Style="{ThemeResource TitleTextBlockStyle}"
                       HorizontalAlignment="Center" />
            
            <StackPanel Orientation="Horizontal" 
                        HorizontalAlignment="Center" 
                        Spacing="15">
                <Button x:Name="RefreshWindowsButton" 
                        Content="Refresh Windows" 
                        Click="RefreshWindowsButton_Click"
                        Padding="15,8" />
                
                <Button x:Name="LlmAnalysisButton" 
                        Content="Analyze with LLM" 
                        Click="LlmAnalysisButton_Click"
                        IsEnabled="False"
                        Padding="15,8" />
                
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <TextBlock Text="FPS:" VerticalAlignment="Center" />
                    <ToggleSwitch x:Name="FpsToggleSwitch" 
                                  OnContent="60" 
                                  OffContent="30" 
                                  IsOn="False"
                                  Toggled="FpsToggleSwitch_Toggled"
                                  IsEnabled="False" />
                </StackPanel>
            </StackPanel>
            
            <TextBlock x:Name="StatusText" 
                       Text="Click 'Refresh Windows' to see available windows, then select one to start video streaming."
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                       Margin="0,5" />
        </StackPanel>
        
        <!-- Window Selection -->
        <ScrollViewer Grid.Row="1" 
                      Grid.ColumnSpan="3"
                      HorizontalScrollMode="Auto" 
                      VerticalScrollMode="Disabled"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Hidden"
                      Margin="20,0,20,20"
                      MaxHeight="250">
            <ListView x:Name="WindowsListView" 
                      SelectionMode="Single"
                      SelectionChanged="WindowsListView_SelectionChanged"
                      ScrollViewer.HorizontalScrollMode="Enabled"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto">
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:WindowInfo">
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="12"
                                Margin="5"
                                Width="280"
                                Height="220">
                            <StackPanel Spacing="8">
                                <Image Source="{x:Bind Thumbnail}" 
                                       Width="240" 
                                       Height="160"
                                       Stretch="Uniform"
                                       HorizontalAlignment="Center" />
                                <TextBlock Text="{x:Bind Title}" 
                                           TextWrapping="Wrap"
                                           MaxLines="2"
                                           TextTrimming="CharacterEllipsis"
                                           HorizontalAlignment="Center"
                                           TextAlignment="Center"
                                           FontSize="12" />
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </ScrollViewer>
        
        <!-- Video Stream Display -->
        <ScrollViewer x:Name="VideoScrollViewer"
                      Grid.Row="2" 
                      Grid.Column="0"
                      ZoomMode="Enabled" 
                      HorizontalScrollMode="Auto" 
                      VerticalScrollMode="Auto"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      Margin="20">
            <Grid x:Name="VideoContainer">
                <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource ControlElevationBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="8">
                    <Grid>
                        <!-- Placeholder for when no video is streaming -->
                        <StackPanel x:Name="VideoPlaceholder" 
                                    HorizontalAlignment="Center" 
                                    VerticalAlignment="Center"
                                    Spacing="10">
                            <SymbolIcon Symbol="Video" 
                                        FontSize="48" 
                                        Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                            <TextBlock Text="Select a window to start video streaming" 
                                       HorizontalAlignment="Center"
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                        </StackPanel>
                        
                        <!-- Video display -->
                        <Image x:Name="VideoImage" 
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Stretch="Uniform"
                               Visibility="Collapsed" />
                    </Grid>
                </Border>
                
                <!-- Overlay Canvas for Rectangle Selection -->
                <Canvas x:Name="SelectionCanvas"
                        Background="Transparent"
                        PointerPressed="SelectionCanvas_PointerPressed"
                        PointerMoved="SelectionCanvas_PointerMoved"
                        PointerReleased="SelectionCanvas_PointerReleased">
                    
                    <!-- Selection Rectangle -->
                    <Rectangle x:Name="SelectionRectangle"
                               Stroke="Red"
                               StrokeThickness="2"
                               Fill="Transparent"
                               Visibility="Collapsed"
                               Canvas.Left="0"
                               Canvas.Top="0"
                               Width="100"
                               Height="100" />
                    
                    <!-- Resize Handles -->
                    <Ellipse x:Name="TopLeftHandle"
                             Fill="Red"
                             Width="10"
                             Height="10"
                             Visibility="Collapsed"
                             PointerPressed="Handle_PointerPressed"
                             Tag="TopLeft" />
                    
                    <Ellipse x:Name="TopRightHandle"
                             Fill="Red"
                             Width="10"
                             Height="10"
                             Visibility="Collapsed"
                             PointerPressed="Handle_PointerPressed"
                             Tag="TopRight" />
                    
                    <Ellipse x:Name="BottomLeftHandle"
                             Fill="Red"
                             Width="10"
                             Height="10"
                             Visibility="Collapsed"
                             PointerPressed="Handle_PointerPressed"
                             Tag="BottomLeft" />
                    
                    <Ellipse x:Name="BottomRightHandle"
                             Fill="Red"
                             Width="10"
                             Height="10"
                             Visibility="Collapsed"
                             PointerPressed="Handle_PointerPressed"
                             Tag="BottomRight" />
                </Canvas>
            </Grid>
        </ScrollViewer>
        
        <!-- Splitter -->
        <Border Grid.Row="2" 
                Grid.Column="1"
                Background="{ThemeResource SystemControlForegroundBaseLowBrush}"
                Width="1" 
                Margin="0,20" />
        
        <!-- LLM Analysis Results Panel -->
        <Grid Grid.Row="2" 
              Grid.Column="2"
              Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            
            <!-- LLM Analysis Results -->
            <TextBlock Grid.Row="0" 
                       Text="LLM Analysis Results" 
                       Style="{ThemeResource SubtitleTextBlockStyle}"
                       Margin="0,0,0,10" />
            
            <ScrollViewer Grid.Row="1" 
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Auto">
                <TextBox x:Name="LlmResultTextBox" 
                         IsReadOnly="True"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         PlaceholderText="LLM analysis results will appear here after clicking 'Analyze with LLM'"
                         MinHeight="400"
                         Background="{ThemeResource LayerFillColorDefaultBrush}"
                         BorderBrush="{ThemeResource ControlElevationBorderBrush}"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         FontFamily="Yu Gothic UI, Meiryo UI, Segoe UI, Tahoma"
                         FontSize="14" />
            </ScrollViewer>
        </Grid>
    </Grid>
</Window>
